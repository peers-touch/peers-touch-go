#!/bin/bash

# Pre-commit hook to check proto compliance
# Copy this file to .git/hooks/pre-commit in your project repository

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Find the proto hub directory
PROTO_HUB_DIR="$(git rev-parse --show-toplevel)/../peers-touch-proto"

# Check if proto hub directory exists
if [ ! -d "$PROTO_HUB_DIR" ]; then
    echo -e "${YELLOW}Warning:${NC} Proto hub directory not found at $PROTO_HUB_DIR"
    echo -e "Skipping proto compliance check."
    exit 0
fi

# Check if compliance script exists
if [ ! -f "$PROTO_HUB_DIR/check_proto_compliance.sh" ]; then
    echo -e "${YELLOW}Warning:${NC} Proto compliance check script not found at $PROTO_HUB_DIR/check_proto_compliance.sh"
    echo -e "Skipping proto compliance check."
    exit 0
fi

# Get the project directory
PROJECT_DIR="$(git rev-parse --show-toplevel)"

# Run the compliance check
echo -e "${BLUE}Running proto compliance check...${NC}"

# Check if any .proto files are being committed
PROTO_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.proto$' || true)

if [ -z "$PROTO_FILES" ]; then
    echo -e "${GREEN}No .proto files being committed. Skipping check.${NC}"
    exit 0
fi

# Run the compliance check
if "$PROTO_HUB_DIR/check_proto_compliance.sh" "$PROJECT_DIR"; then
    echo -e "${GREEN}Proto compliance check passed.${NC}"
    exit 0
else
    echo -e "${RED}Proto compliance check failed.${NC}"
    echo -e "${YELLOW}Please define your proto files in the central proto hub repository first.${NC}"
    echo -e "See $PROTO_HUB_DIR/PROTO_GUIDELINES.md for more information."
    
    # Ask if the user wants to continue anyway
    echo -e "\n${YELLOW}Do you want to commit anyway? (y/N)${NC}"
    read -r response
    if [[ "$response" =~ ^([yY][eE][sS]|[yY])$ ]]; then
        echo -e "${YELLOW}Continuing with commit despite proto compliance issues.${NC}"
        exit 0
    else
        echo -e "${RED}Commit aborted.${NC}"
        exit 1
    fi
fi