# AI 多模态输入框设计（对齐 LobeChat 交互，增强桌面能力）

> 面向桌面端（Windows/macOS/Linux）的专业 AI 输入框，支持文本 + 图片/文件 + 语音 + 截图等多模态组合输入；与现有三栏骨架对齐 LobeChat 风格。本文档用于规范实现与验收，供前端与交互协作参考。

## 设计目标
- 提供顺滑的「编写 → 组合 → 发送」体验，避免溢出与布局异常。
- 以模块化方式支持多模态素材的收集、预览、序列化与发送。
- 支持 Enter/Ctrl+Enter 发送模式切换，与 LobeChat 行为一致。
- 在不阻塞输入的情况下，允许拖拽文件/图片、粘贴剪贴板、截图、语音录制。
- 输入框可自适应高度（最小 44px，最大 280px），超过则进入内部滚动。

## 能力清单（MVP+）
- 文本输入：Markdown 友好，支持代码块、行内代码、行内公式；禁用富文本但保留渲染提示。
- 图片输入：支持文件选择、拖拽、剪贴板粘贴（`image/png|jpeg`）、屏幕截图落地（PNG）。
- 文件输入：`pdf/docx/txt/json` 等，按模型能力做格式过滤与体积上限校验。
- 语音输入：桌面麦克风录音（PCM/WAV/WEBM），本地转写或服务端转写为文本；原始音频可作为附件发送。
- 快速操作：重置草稿、清除附件、打开模版库、插入变量（如 `@file`、`#topic`）。
- 发送模式：`Enter` 发送或 `Ctrl+Enter` 发送切换；`Shift+Enter` 固定为换行。
- 草稿持久化：会话级最近一次草稿内容与附件托管在本地（避免误关闭丢失）。

## 布局与交互（参考 LobeChat 截图）
- 主体结构
  - 输入区：可增长的多行文本框，占 1 行到最多 8 行；超出进入内部滚动。
  - 工具栏（底部，左右分组）：
    - 左侧分组（素材采集）：
      - `T` 文案助手（可选）：打开小面板进行文字润色/改写再回填。
      - 图片选择/拖拽区、截图按钮、文件选择、粘贴提示（当剪贴板含图片/文件时高亮）。
      - 语音按钮：录制/暂停/删除；转写完成后插入文本并保留源音频为附件。
    - 中间分组（编排/高级）：模版库、变量插入、参数面板（温度、最大 token）。
    - 右侧分组（发送）：发送主按钮、模式下拉（`Enter`/`Ctrl+Enter`）、更多菜单（清空草稿、只发送附件、仅重试上条）。
- 交互细节
  - 粘贴图片：显示缩略图卡片（可添加 alt 文案）；支持删除、替换、查看原图。
  - 拖拽到输入框：显示接收态边框，松手后进入附件托盘。
  - 截图：调用系统截图（Windows 可用 `printscreen` 或内置采集服务），落地为 PNG 并进入托盘。
  - 语音：录制时显示时长与音量条，停止后自动转写（本地/云端），文本插入到光标处，音频保留在附件托盘。
  - 错误态：附件类型/大小不符、转写失败、序列化失败时显示行内错误卡片。

## 键盘与快捷键
- `Enter` 或 `Ctrl+Enter`：依设置/右侧下拉决定发送；`Shift+Enter` 强制换行。
- `Esc`：失焦或取消录制/截图；当附件托盘处于选择态时清空选择。
- `Ctrl+K`：打开素材插入面板（图片/文件/语音/截图）。
- `Ctrl+Shift+V`：优先粘贴纯文本；`Ctrl+V` 会尝试解析图片/文件剪贴板。
- `Ctrl+/`：打开命令面板（模版、变量、最近提示）。

## 状态机（ComposerState）
- `idle`：空草稿，无附件。
- `editing`：文本输入中，可能含附件。
- `validating`：校验文本与附件、大小与类型。
- `sending`：序列化并发送（可流式）。
- `error`：提示错误卡片并保持草稿内容不丢失。

## 数据模型与序列化（对齐 OpenAI messages content 数组）
- `AiComposerDraft`
  - `text`: `String`
  - `attachments: List<AiAttachment>`
  - `sendMode: 'enter' | 'ctrlEnter'`
  - `createdAt`, `updatedAt`
- `AiAttachment`
  - `id`, `type: 'image' | 'file' | 'audio' | 'video'`
  - `mime`, `bytes/base64/path`, `source: 'clipboard' | 'drag' | 'picker' | 'screenshot' | 'record'`
  - `meta`: `{ name?, size?, alt?, duration? }`
- 发送时的消息打包（示例）
  ```json
  {
    "role": "user",
    "content": [
      { "type": "text", "text": "请分析这张图并给出步骤" },
      { "type": "input_text", "text": "（语音转写补充）" },
      { "type": "image_url", "image_url": { "url": "data:image/png;base64,<...>" } },
      { "type": "file", "file": { "name": "report.json", "mime": "application/json", "data": "<base64>" } }
    ]
  }
  ```
- OpenAI 协议兼容策略
  - 图片走 `image_url.url = data:image/png;base64,...`；文件以工具/函数调用或后端托管 URL 方式处理。
  - 语音转写后的文本并入 `text`，原音频作为 `file/audio` 附件（可选）。

## 组件与目录结构（建议）
```
lib/features/ai_chat/widgets/input_box/
├── ai_input_box.dart                 # 容器（组合输入区、附件托盘、工具栏）
├── input_area.dart                   # 可增长文本框（EditableText 包裹 + Actions/Shortcuts）
├── toolbar.dart                      # 左中右分组按钮、发送模式切换
├── attachment_tray.dart              # 附件卡片栅格（缩略图、文件条目、删除/预览）
├── voice_recorder.dart               # 录音器（状态与波形）
├── screenshot_capture.dart           # 截图采集（桌面平台封装）
├── controller/ai_input_controller.dart
└── models/
    ├── ai_composer_draft.dart
    └── ai_attachment.dart
```

## 行为规范与校验
- 文本为空且无附件时禁用发送。
- 单次消息最大体积（可配）：文本 32KB、图片 4MB*4、文件总计 16MB、音频 12MB。
- 文件白名单：`pdf|docx|txt|json|csv|md|png|jpg|webp|wav|mp3`。
- 图片至少包含一项 alt 或在发送前提示补充上下文（可关闭）。
- 当输入框宽度过窄时：工具栏切换为图标+省略号折叠菜单以避免 `Row` 溢出。

## 发送模式与快捷键切换（与设置联动）
- 全局设置项：`settings:ai_chat:composer_send_mode = enter|ctrlEnter`。
- 输入框右侧下拉仅影响当前会话的运行时模式，并在退出页面时持久化到全局设置。

## 错误与空态
- 剪贴板不含受支持类型时：展示灰色文案“粘贴文本或图片/文件”。
- 附件过大/类型不支持：红色警示条并提供删除按钮。
- 录音失败/无设备：面板提示并引导到系统设置。

## 验收标准（MVP+）
- 支持文本 + 至少 1 种图片来源（粘贴或拖拽）+ 语音录制并转写为文本。
- 工具栏在窄宽下不会产生 `Row` 溢出（自适应折叠）。
- 发送模式切换生效，快捷键行为与文案一致。
- 草稿在刷新或返回后可恢复（同会话）。
- 序列化符合 OpenAI `messages.content[]` 约定并成功发送。

## 实施步骤（建议）
1. 模型与 DTO：实现 `AiAttachment`、`AiComposerDraft` 及序列化到 OpenAI `content[]`。
2. 控制器：`AiInputController` 管理草稿、附件托盘、录音/截图状态、发送模式。
3. 视图：`AiInputBox` + `InputArea` + `Toolbar` + `AttachmentTray` 搭建交互与窄宽折叠策略。
4. 桌面能力：剪贴板图片解析、拖拽文件接入、录音器与截图采集封装（Windows 优先）。
5. 设置联动：读写 `composer_send_mode`，并与右侧下拉同步。
6. 校验与错误态：统一校验入口与行内错误卡片组件。
7. 联调：在聊天页底部替换现有输入框，完成集成测试与预览。

## 参考占位与文案
- 占位：`在此输入消息，按 Enter 发送，按 Ctrl+Enter 换行...`
- 发送按钮：`发送`
- 语音：`开始录音 / 停止录音 / 删除录音`
- 截图：`屏幕截图`

---
本规范与 `PROMPTs/1.ai_chat.zh.md` 保持一致的风格与目录组织，开发中如遇桌面平台差异（驱动权限、编解码支持）需在服务层屏蔽，视图层不感知平台差异。