# 设置页功能规范

> 基于全局UI架构骨架，定义设置页的具体功能实现规范，包括设置项类型、分区管理、交互体验和数据持久化等完整方案。

## 核心定位

设置页作为Peers Touch桌面应用的核心系统功能模块，采用**统一设置管理 + 业务模块注入**的架构模式，为所有功能模块提供集中化的配置管理界面。

## 设计参考基准

### 现代桌面应用设置页设计模式

- **左侧导航 + 右侧内容**：固定导航区与自适应内容区分离
- **分类管理**：按功能逻辑组织设置项，便于用户快速定位
- **实时生效**：设置项修改即时应用，提供即时反馈
- **搜索功能**：支持全局搜索，快速定位特定设置项

## 整体架构设计

### 布局结构
```
┌─────────────────┬─────────────────────────────┐
│                 │                             │
│   左侧导航区    │        右侧内容区           │
│   (240px固定)   │        (自适应宽度)         │
│                 │                             │
│  • 通用设置     │  ┌─────────────────────┐   │
│  • 外观主题     │  │   分区标题            │   │
│  • 隐私安全     │  │                     │   │
│  • AI配置       │  │  ┌─────────────────┐ │   │
│  • 通知设置     │  │  │ 设置项1         │ │   │
│  • 关于         │  │  │ 设置项2         │ │   │
│                 │  │  │ 设置项3         │ │   │
│                 │  │  └─────────────────┘ │   │
│                 │  │                     │   │
│                 │  └─────────────────────┘   │
└─────────────────┴─────────────────────────────┘
```

### 核心设计原则

1. **一致性**：所有设置项遵循统一的视觉和交互规范
2. **可发现性**：设置项组织清晰，便于用户快速找到所需配置
3. **即时反馈**：设置修改实时生效，提供明确的视觉反馈
4. **容错性**：重要操作提供确认机制，防止误操作

## 设置项类型规范

### 1. 分区标题 (Section Header)

- **用途**：用于设置项的分组显示
- **视觉样式**：较大的标题字体，适当的上下间距
- **交互**：不可交互，仅用于视觉分组

### 2. 开关切换 (Toggle)

- **用途**：布尔值设置项（如：深色模式、自动更新）
- **控件**：Material Design Switch组件
- **交互**：点击切换状态，即时生效
- **状态反馈**：开关状态明确，支持描述性文本

### 3. 下拉选择 (Select)

- **用途**：枚举值设置项（如：语言选择、主题风格）
- **控件**：DropdownButton或自定义选择器
- **交互**：点击展开选项列表，选择后收起
- **选项显示**：支持选项描述和图标

### 4. 文本输入 (Text Input)

- **用途**：字符串设置项（如：API密钥、用户名）
- **控件**：TextField，支持验证和提示
- **交互**：聚焦时显示键盘，支持复制粘贴
- **验证**：支持输入格式验证和错误提示

### 5. 按钮操作 (Button)

- **用途**：触发操作的设置项（如：清除缓存、重置设置）
- **控件**：ElevatedButton或TextButton
- **交互**：点击触发操作，可能需要确认
- **状态反馈**：操作结果明确提示

### 6. 分割线 (Divider)

- **用途**：视觉分隔设置项
- **样式**：细线分隔，适当的上下间距
- **交互**：不可交互，仅用于视觉分隔

## 设置分区设计

### 核心分区定义

#### 1. 通用设置 (General)

- **定位**：应用基础配置和常用设置
- **设置项示例**：
  - 启动时自动运行
  - 最小化到系统托盘
  - 默认打开页面
  - 快捷键配置

#### 2. 外观主题 (Appearance)

- **定位**：UI视觉相关设置
- **设置项示例**：
  - 深色/浅色主题切换
  - 主题颜色定制
  - 字体大小调整
  - 界面缩放比例

#### 3. 隐私安全 (Privacy & Security)

- **定位**：数据保护和权限管理
- **设置项示例**：
  - 数据收集同意
  - 自动清除历史记录
  - 密码保护
  - 权限管理

#### 4. AI配置 (AI Configuration)

- **定位**：AI服务相关设置
- **设置项示例**：
  - AI服务提供商选择
  - API密钥管理
  - 模型参数配置
  - 响应风格设置

#### 5. 通知设置 (Notifications)

- **定位**：消息提醒配置
- **设置项示例**：
  - 桌面通知开关
  - 声音提醒设置
  - 免打扰时段
  - 通知优先级

#### 6. 关于 (About)

- **定位**：应用信息和帮助
- **设置项示例**：
  - 版本信息显示
  - 检查更新
  - 用户协议
  - 反馈与支持

## 交互体验设计

### 导航交互

- **分区切换**：点击左侧分区，右侧内容平滑切换
- **选中状态**：当前选中分区高亮显示，支持键盘导航
- **滚动同步**：左侧导航支持独立滚动，右侧内容区独立滚动

### 内容交互

- **实时生效**：大多数设置项修改即时应用
- **确认机制**：重要操作（如重置、删除）需要二次确认
- **状态反馈**：操作结果提供明确的成功/失败提示
- **撤销功能**：支持重要设置的撤销操作

### 搜索功能

- **全局搜索**：支持在所有设置项中搜索关键词
- **搜索结果**：高亮匹配项，支持直接跳转
- **搜索建议**：提供搜索建议和热门设置项

## 数据持久化设计

### 存储策略

- **本地存储**：使用GetStorage进行本地持久化
- **自动保存**：设置项修改后自动保存到本地
- **备份机制**：支持设置项的导入/导出功能
- **版本兼容**：支持设置项格式的版本升级

### 数据同步

- **实时同步**：设置修改实时反映到应用各模块
- **冲突解决**：处理多窗口同时修改设置的冲突
- **回滚机制**：支持设置错误的自动回滚

## 配置类型结构位置规范

### 设置项模型定义位置
根据项目目录架构规范，设置页相关的配置类型结构应放置在对应的业务模块目录下：

```
lib/features/settings/
├── model/                           # 模块数据模型目录
│   ├── setting_item.dart           # 设置项基础模型定义
│   ├── setting_section.dart        # 设置分区模型定义
│   ├── setting_types.dart          # 设置项类型枚举定义
│   └── setting_value.dart          # 设置值包装器模型
├── controller/                      # 模块控制器
│   └── setting_controller.dart     # 设置页控制器
├── view/                           # 模块视图
│   └── setting_page.dart           # 设置页主界面
└── setting_binding.dart            # 模块依赖绑定
```

### 设置管理器位置
设置管理器作为全局服务，应放置在core/services/目录下：

```
lib/core/services/
└── setting_manager.dart            # 全局设置管理器（单例模式）
```

### 业务模块设置注入位置
各业务模块的设置项定义应放置在各自模块的model目录下：

```
lib/features/chat/                   # 聊天模块
├── model/
│   ├── chat_setting_item.dart      # 聊天相关设置项定义
│   └── chat_message.dart           # 聊天消息模型

lib/features/ai/                     # AI模块  
├── model/
│   ├── ai_setting_item.dart        # AI相关设置项定义
│   └── ai_model.dart               # AI模型定义
```

### 导入路径规范
所有import必须使用绝对路径：

```dart
// 正确示例
import 'package:peers_touch_desktop/features/settings/model/setting_item.dart';
import 'package:peers_touch_desktop/core/services/setting_manager.dart';

// 错误示例（禁止使用相对路径）
import '../model/setting_item.dart';
```

### 模型定义规范
每个设置项模型必须包含完整的序列化/反序列化方法：

```dart
class SettingItem {
  final String id;
  final String title;
  final SettingItemType type;
  final dynamic defaultValue;
  
  SettingItem({
    required this.id,
    required this.title,
    required this.type,
    required this.defaultValue,
  });
  
  Map<String, dynamic> toJson() => {
    'id': id,
    'title': title,
    'type': type.name,
    'defaultValue': defaultValue,
  };
  
  factory SettingItem.fromJson(Map<String, dynamic> json) => SettingItem(
    id: json['id'],
    title: json['title'],
    type: SettingItemType.values.firstWhere((e) => e.name == json['type']),
    defaultValue: json['defaultValue'],
  );
}
```

### 设置注册接口

- **统一注册**：所有业务模块通过统一接口注册设置项
- **动态注入**：支持运行时动态添加/移除设置项
- **权限控制**：支持设置项的可访问性控制

### 设置项定义规范

每个设置项包含以下元数据：
- **唯一标识**：全局唯一的设置项ID
- **显示标题**：用户可见的设置项名称
- **描述文本**：设置项的详细说明
- **设置类型**：开关、选择、输入等类型
- **默认值**：设置项的默认值
- **验证规则**：输入值的验证规则
- **依赖关系**：与其他设置项的依赖关系

## 错误处理与边界情况

### 初始化错误
- **依赖缺失**：处理设置管理器初始化失败的情况
- **数据损坏**：处理设置数据损坏的恢复机制
- **版本不兼容**：处理旧版本设置的升级转换

### 用户操作错误
- **无效输入**：提供清晰的错误提示和修正建议
- **权限不足**：处理设置项访问权限不足的情况
- **网络错误**：处理需要网络连接的设置项错误

### 性能优化
- **懒加载**：设置项内容按需加载，避免初始化阻塞
- **缓存机制**：常用设置项缓存，提高访问速度
- **批量操作**：支持设置项的批量修改和保存

## 测试与验证

### 功能测试
- **设置项功能**：验证每种设置类型的正常功能
- **数据持久化**：验证设置项的保存和读取正确性
- **模块集成**：验证业务模块设置项的注入和访问

### 用户体验测试
- **导航流畅性**：验证分区切换的流畅性
- **搜索准确性**：验证搜索功能的准确性和性能
- **错误处理**：验证各种错误情况下的用户体验

---

**本规范为设置页功能实现的完整指导，所有开发者在实现设置页相关功能时都应严格遵循本规范。**