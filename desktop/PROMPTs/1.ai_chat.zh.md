# AI Chat 模块设计（MVP）

> 需严格遵循项目总纲 `PROJECT_BASE_PROMPT.zh.md` 与本目录规范。所有 import 使用绝对路径，模块内聚（Controller/View/Model/Binding 位于同一业务模块目录下），依赖注入通过 Binding 完成，不得硬实例化。

## 设计目标
- 对齐 LobeChat 风格的三栏布局与交互，但仅实现 MVP 必需能力。
- 通过 OpenAI 协议 Provider 配置与鉴权，动态拉取支持模型列表。
- 以最小可用的“聊天即用”体验：创建会话、选择模型、输入消息、获取回复。

## MVP 范围（Scope）
- Provider 设置（OpenAI 协议）
  - 配置 `baseUrl`、`apiKey` 等必要字段。
  - 从 Provider 拉取 `models` 列表，供聊天页选择。
- AI Chat 主页面（LobeChat风格）
  - 左栏：会话列表（含搜索），支持新建/选择会话。
  - 中栏：消息时间线（用户/助手气泡），底部输入区（文本 + 发送）。
  - 右栏：扩展面板占位（后续扩展，MVP 中仅保留结构）。
- 不在本期的功能（Non-goals）
  - 文件上传、工具调用、函数调用链、插件系统。
  - 多模型路由/并行推理、可视化思维链、提示编排工作流。
  - 对话持久化/多端同步（MVP 可仅本地暂存）。

## 模块目录结构（建议）
```
lib/features/ai_chat/
├── controller/
│   └── ai_chat_controller.dart       # GetX 控制器（状态与业务逻辑）
├── view/
│   └── ai_chat_page.dart             # 主页面（对齐 LobeChat 三栏骨架）
├── binding/
│   └── ai_chat_binding.dart          # 依赖注入（Get.lazyPut 控制器/服务）
├── model/
│   ├── chat_message.dart             # 消息模型（id/role/content/timestamp/...）
│   └── chat_session.dart             # 会话模型（id/title/lastActive/...）
├── service/
│   ├── ai_chat_service.dart          # 聊天服务抽象（sendMessage/stream...）
│   └── openai_provider_service.dart  # OpenAI协议 Provider实现（拉取模型/推理）
└── ai_provider_settings.dart         # 与设置页联动的配置项（已存在，可复用）
```

## 状态管理（GetX）
- `AIChatController`
  - `RxList<ChatSession> sessions`：会话列表
  - `RxString selectedSessionId`：当前选中的会话
  - `RxList<ChatMessage> messages`：当前会话的消息时间线
  - `RxList<String> models`：Provider 动态拉取的模型列表
  - `RxString currentModel`：当前选择的模型
  - `RxBool isSending`、`RxString? error`：发送状态与错误提示
  - 方法：
    - `loadModels()`：读取设置中 Provider 配置并拉取模型
    - `createSession()` / `selectSession(String id)`
    - `sendMessage(String text)`：写入用户消息、调用服务获取助手消息

## UI骨架（对齐 LobeChat风格）
- 使用 `LobeTokens` 风格变量与 `AppTheme` 中的主题定义（紫色品牌色）。
- 布局：
  - 左栏（240px）：
    - 顶部搜索框（模块内搜索，二级菜单顶部，已在设置页验证交互）
    - 会话列表项（头像/标题/时间/悬浮态/选中态）
  - 中栏：
    - 顶部工具条：模型选择下拉、当前 Provider 指示（只读）
    - 消息时间线：用户与助手气泡（圆角/阴影/分隔线）
    - 底部输入区：单行/多行文本、`发送` 按钮
  - 右栏：扩展面板占位（MVP 仅结构，不实现内容）

## 交互流程（MVP）
1. 首次进入：读取设置页中的 Provider 配置（`baseUrl`、`apiKey`）。
2. 调 `loadModels()`：`GET <baseUrl>/v1/models` 拉取列表，填充 `models` 与默认 `currentModel`。
3. 新建会话：初始化空的 `messages`，焦点定位输入框。
4. 发送消息：
   - 写入用户消息（role=`user`）。
   - 调 `POST <baseUrl>/v1/chat/completions`（OpenAI协议），参数包含 `model` 与 `messages`。
   - 成功：写入助手消息（role=`assistant`）；失败：错误提示到 `error`。

## Provider 与 API 契约（OpenAI协议）
- 拉取模型列表
  - `GET /v1/models`
  - Header：`Authorization: Bearer <token>`
  - 返回示例：`{ data: [ { id: "gpt-4o" }, { id: "gpt-4o-mini" } ] }`
- 聊天补全（MVP）
  - `POST /v1/chat/completions`
  - Header：`Authorization: Bearer <token>`
  - Body 示例：
    ```json
    {
      "model": "gpt-4o",
      "messages": [
        { "role": "system", "content": "You are a helpful assistant." },
        { "role": "user", "content": "你好" }
      ]
    }
    ```
  - 返回（简化）：`{ choices: [ { message: { role: "assistant", content: "你好！" } } ] }`

## 数据模型（建议）
- `ChatMessage`
  - 字段：`id`、`role`(`user|assistant|system`)、`content`、`timestamp`、`status`(`normal|error|streaming`)。
- `ChatSession`
  - 字段：`id`、`title`、`createdAt`、`lastActiveAt`。

## 设置页联动（已有基础）
- 通过 `SettingManager.registerSection` 注入：
  - `openai_api_key`（安全存储）
  - `openai_base_url`
  - `model_selection`（默认模型，可由聊天页覆盖为运行时所选）
- 聊天页进入时：
  - 读取 `LocalStorage/SecureStorage` 持久化值（由 `SettingController` 管理）。
  - `AIChatController.loadModels()` 若失败，显示错误卡片，引导用户完成设置。

## 依赖注入（Binding）
- `AIChatBinding`
  - `Get.lazyPut<OpenAIProviderService>(() => OpenAIProviderService(...))`
  - `Get.lazyPut<AIChatController>(() => AIChatController())`
- 页面路由：在 `AppPages` 注册 `ai_chat` 对应页面与 Binding。

## 持久化策略（MVP）
- 会话与消息：内存为主，离开页面不保证持久化（后续迭代）。
- Provider 配置：沿用设置页现有的 `LocalStorage` 与 `SecureStorage`。
- 当前模型：可在本地存储 `settings:ai_chat:current_model`（可选）。

## 国际化（i18n）
- 增加文案键：`aiChatTitle`、`newChat`、`send`、`model`、`providerMissingConfig`、`loadModelsFailed`、`noMessages` 等。
- 按项目 `l10n.yaml` 生成到 `lib/app/i18n/generated`。

## 验收标准（MVP）
- 能在设置页填好 Provider 配置后进入聊天页并成功拉取模型列表。
- 能创建会话、选择模型、发送文本消息并获得助手回复。
- 页面风格对齐 LobeChat：三栏骨架、圆角卡片、紫色品牌色、清晰的层级背景（`bgLevel1/2/3`）。

## 实施步骤（建议）
1. 服务层：实现 `openai_provider_service.dart` 的 `getModels()` 与 `chatCompletions()`。
2. 控制器：实现 `AIChatController` 的状态字段与调用服务的流程。
3. 页面：搭建 `ai_chat_page.dart` 三栏骨架与交互（模型下拉、消息列表、输入区）。
4. 路由与绑定：在 `AppPages` 注册页面，`ai_chat_binding.dart` 注入依赖。
5. 设置联动：复用 `ai_provider_settings.dart` 并确保即时生效（与现有设置页模式一致）。
6. i18n：补齐聊天页文案并生成。
7. 验证与预览：`flutter run -d chrome` 启动，检查模型拉取与发送流程。

## 后续路线（非MVP）
- 流式输出（SSE/Chunk）与打字机效果；消息编辑与重试；系统提示管理。
- 多会话持久化与检索；导入/导出；提示库与模版。
- 工具调用（函数调用/插件）、图片/文件输入、多模态模型支持。