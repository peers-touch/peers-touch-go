# AI Chat 页面骨架规范（对齐 LobeChat 风格）

## 1. 目标与原则
- 目标：在现有“仅有发送框”的基础上，搭建与 LobeChat 类似的三栏聊天骨架，先行完成 UI 布局与基础交互，后续逐步接入消息流与工具能力。
- 一致性：遵循项目现有的 UI 规范与 SOP，布局与交互尽量与 LobeChat保持一致。
- 渐进式实现：优先完成骨架与无数据态，随后接入流式消息、历史会话与主题面板。
- 可扩展：组件化拆分，支持未来接入多模型、助手列表、工具插件、消息操作等能力。

## 2. 页面整体布局骨架
- 三栏结构：左侧侧栏（助手/会话）、中间聊天区、右侧主题面板。
- 宽度建议：
  - 左侧侧栏：`280px` 固定宽度。
  - 中间聊天区：自适应。
  - 右侧主题面板：`320px` 固定宽度，可隐藏/显示。
- 全局顶部（中栏内顶部）工具区：包含页面标题与一组操作按钮，与 LobeChat 的顶部工具栏对齐。

## 3. 顶部工具栏（中栏内部）
- 标题区：显示当前会话/助手名称，默认 `Just Chat`。
- 操作按钮：
  - `显示/隐藏主题面板`（Topic Panel Toggle）。
  - `布局切换`（右侧面板开启/关闭，预留占位）。
  - `更多菜单`（会话设置、清空、归档，预留占位）。
- 快速模型选择：在标题右侧提供 `模型下拉框`，默认显示当前模型，例如 `llama3:8b`。

## 4. 左侧侧栏（助手/会话）
- 顶部搜索框：`搜索会话/助手`，支持键入过滤（后续接入）。
- `新建对话` 按钮：创建新会话并跳转到中间聊天区。
- 列表区域：
  - 会话列表（默认空态时显示占位文案）。
  - 未来可切换“助手列表”和“会话列表”。
- 底部固定区：可放置设置入口或小工具按钮（与现有主菜单保持统一）。

## 5. 中间聊天区
- 消息列表：
  - 支持空态：展示欢迎/引导文案（如“输入消息…”）。
  - 消息按时间顺序显示；后续支持按天分组与锚点导航。
  - 流式渲染：与 `OllamaService.sendMessageStream` 对接，逐 token 更新。
- 输入区（已存在）：
  - 文本框、发送按钮；支持 `Ctrl+Enter` 发送。
  - 预留：文件/图片附件按钮、常用 Prompt 选择、停止生成按钮。

## 6. 右侧主题面板（Topic Panel）
- 切换按钮在顶部工具栏中控制显示/隐藏。
- 内容：
  - `本周` 与 `默认主题` 列表，支持查看与切换。
  - 预留创建/重命名/归档接口。
- 面板宽度：`320px`；默认显示，可在首次进入时根据用户偏好记忆状态。

## 7. 组件拆分与文件结构（建议）
- `features/ai_chat/view/ai_chat_page.dart`：页面入口（中栏 + 顶部工具栏 + 列表 + 输入区 + 右侧面板容器）。
- `features/ai_chat/widgets/chat_header_bar.dart`：顶部工具栏（标题、按钮、模型选择）。
- `features/ai_chat/widgets/assistant_sidebar.dart`：左侧侧栏（搜索、新建、列表）。
- `features/ai_chat/widgets/message_list_view.dart`：消息列表（空态与未来虚拟化）。
- `features/ai_chat/widgets/message_bubble.dart`：消息气泡（角色、状态、操作）。
- `features/ai_chat/widgets/chat_input_bar.dart`：输入栏（文本框、发送、附件占位）。
- `features/ai_chat/widgets/topic_panel.dart`：右侧主题面板。

## 8. 状态模型与数据流
- 控制器：`AIChatController`（基于 GetX）。
- 关键状态：
  - `RxList<Message> messages`：消息列表。
  - `RxString inputText`：输入框内容。
  - `RxBool isStreaming`：是否正在流式生成。
  - `RxString currentModel`：当前模型（如 `llama3:8b`）。
  - `RxString? conversationId`：当前会话ID。
  - `RxBool showTopicPanel`：是否显示右侧面板。
  - 预留：`selectedAssistant`、`toolsEnabled`、`attachments`。
- 事件流：
  - 新建对话 → 初始化会话状态 → 焦点定位输入框。
  - 发送消息 → 调用 `OllamaService.sendMessageStream` → 逐 token 更新 `messages` → 结束后落库。
  - 切换模型 → 更新 `currentModel` 并影响后续生成。
  - 切换主题面板 → 更新 `showTopicPanel`，右侧面板显隐。

## 9. 消息气泡与操作（一期占位需求）
- 基础：支持 `user` 与 `assistant` 两种角色气泡，展示头像/图标与时间。
- 操作：复制、重新生成、停止生成（停止按钮仅在流式中显示）。
- 辅助信息：状态提示（生成中、失败、已停止），错误提示与重试按钮占位。

## 10. 空状态与用户引导
- 左侧列表空态：显示“会话列表（占位）”与“新建对话”按钮。
- 中间消息区空态：显示欢迎语与快捷键提示。
- 右侧面板空态：显示默认主题与创建按钮占位。

## 11. 快捷键与交互细节 （暂不实现）
- `Ctrl+K`：聚焦左侧搜索框。
- `Ctrl+Enter`：发送消息。
- `Ctrl+Shift+T`：显示/隐藏主题面板。
- `Esc`：取消输入或关闭浮层。

## 12. 视觉与样式（简要）
- 颜色与间距遵循全局主题；支持 `light/dark`。
- 列表项与气泡的圆角、投影与间距与设置页保持一致风格。
- 顶部工具栏图标与交互反馈与 LobeChat 对齐（悬浮提示、按下态）。

## 13. 适配与性能
- 虚拟列表：消息多时采用懒加载或虚拟化（后续）。
- 流式合帧：token 频繁更新时进行帧合并，降低重绘。
- 响应式：窄屏下右侧面板默认隐藏，仅通过按钮呼出。

## 14. 实现节奏（里程碑）
- M1：引入三栏骨架与顶部工具栏；左侧搜索 + 新建；右侧面板可显隐；中间空态与输入框联动。
- M2：接入 `OllamaService.sendMessageStream`，完成基础问答与流式展示；添加停止生成与重试按钮占位。
- M3：会话与主题的持久化与切换；消息操作（复制、重新生成）。
- M4：附件/工具栏基础入口；模型切换与会话级设置。

## 15. 与主框架的对齐
- 一级菜单：`AIChatModule` 注册保持现状，`toDIsplayPageTitle=false`（左侧二级导航顶部不显示功能标题）。
- 依赖注入：通过 `AIChatBinding` 注入控制器；页面通过 `GetBuilder` 渲染。
- 服务层：继续使用 `ollama_service.dart` 的流式接口，保持类型兼容（Web端已修复）。

## 16. 验收清单（Prompt Checklist）
- 左侧侧栏具备搜索、新建按钮与占位列表。
- 顶部工具栏包含标题、主题面板开关、布局切换、更多菜单与模型下拉。
- 中间聊天区渲染空态并可发送消息（M2流式后验证）。
- 右侧主题面板可显隐，显示默认主题列表。
- 快捷键 `Ctrl+K / Ctrl+Enter / Ctrl+Shift+T` 生效或有占位提示。
- 视觉与交互与现有设置页风格统一；暗亮主题可切换。

— 完 —