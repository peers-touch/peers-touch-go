# 依赖注入绑定规范

## InitialBinding 设计说明

### 定位与职责

`InitialBinding` 是应用启动时的全局依赖注入绑定器，负责注册所有全局单例服务。它位于 `app/bindings/` 目录下，属于**应用级核心配置**的一部分。

### 核心职责

1. **全局服务注册**：注册应用生命周期内始终存在的单例服务
2. **依赖关系管理**：确保服务之间的依赖关系正确建立
3. **生命周期管理**：使用 `permanent: true` 确保服务在整个应用生命周期内保持活跃

### 设计原则

#### 1. 分层注册
将服务按功能模块分层注册，提高代码可读性和维护性：

```dart
class InitialBinding extends Bindings {
  @override
  void dependencies() {
    _registerStorageServices();    // 存储层服务
    _registerNetworkServices();    // 网络层服务  
    _registerBusinessServices();   // 业务层服务
  }
}
```

#### 2. 依赖顺序
确保依赖关系正确建立，被依赖的服务先注册：

```dart
// 正确的注册顺序
_registerStorageServices();    // SecureStorage 先注册
_registerNetworkServices();    // ApiClient 依赖 SecureStorage
```

#### 3. 单例模式
所有全局服务都使用 `permanent: true` 注册为单例：

```dart
Get.put<Service>(Service(), permanent: true);
```

### 服务分类规范

#### 存储层服务 (`_registerStorageServices`)
- **LocalStorage**：本地数据存储（GetStorage封装）
- **SecureStorage**：安全存储（加密敏感数据）

#### 网络层服务 (`_registerNetworkServices`)
- **NetworkStatusService**：网络状态监控
- **ApiClient**：网络请求客户端（依赖 SecureStorage 和 NetworkStatusService）

#### 业务层服务 (`_registerBusinessServices`)
- **UserStatusService**：用户在线状态管理
- 其他跨模块共享的业务服务

### 扩展规范

#### 新增全局服务
当需要添加新的全局服务时：

1. **确定服务类型**：属于存储层、网络层还是业务层
2. **创建对应方法**：在相应层的方法中添加注册逻辑
3. **处理依赖关系**：确保依赖的服务已先注册

```dart
/// 新增业务服务示例
void _registerBusinessServices() {
  Get.put<UserStatusService>(UserStatusService(), permanent: true);
  Get.put<NotificationService>(NotificationService(), permanent: true); // 新增
}
```

#### 模块级绑定
对于业务模块特定的控制器，使用模块级绑定（如 `home_binding.dart`）：

```dart
// features/home/home_binding.dart
class HomeBinding extends Bindings {
  @override
  void dependencies() {
    Get.lazyPut<HomeController>(() => HomeController()); // 懒加载，页面销毁时回收
  }
}
```

### 使用规范

#### 服务获取
在代码中获取服务时，必须使用 `Get.find<T>()`：

```dart
// 正确
final apiClient = Get.find<ApiClient>();
final storage = Get.find<LocalStorage>();

// 错误 - 禁止硬实例化
final apiClient = ApiClient(); // ❌
```

#### 错误处理
获取服务时应该处理可能的异常：

```dart
try {
  final service = Get.find<SomeService>();
  // 使用服务
} catch (e) {
  // 处理服务未找到的情况
}
```

### 测试支持

#### Mock 服务注册
在测试环境中，可以注册 Mock 服务替代真实实现：

```dart
// 测试设置
Get.put<ApiClient>(MockApiClient(), permanent: true);
```

#### 测试清理
测试完成后清理注册的服务：

```dart
// 测试清理
Get.reset();
```

### 最佳实践

1. **单一职责**：每个服务类应该有明确的单一职责
2. **接口隔离**：服务之间通过接口交互，降低耦合度
3. **依赖倒置**：高层模块不依赖低层模块，都依赖抽象
4. **配置化**：服务的配置参数应该通过配置文件管理

### 常见问题

#### Q: 什么时候应该使用模块级绑定而不是全局绑定？
A: 当服务只在特定业务模块中使用，且不需要在整个应用生命周期内存在时，使用模块级绑定。

#### Q: 如何处理循环依赖？
A: 避免循环依赖，如果确实需要，可以通过接口抽象或依赖注入容器解决。

#### Q: 服务初始化失败怎么办？
A: 在 `AppInitializer` 中处理初始化异常，提供友好的错误提示和恢复机制。

### 版本历史

- v1.0: 初始版本，包含基础存储、网络、业务服务注册
- v1.1: 增加分层注册结构，提高代码可读性

---

通过遵循这些规范，可以确保应用的依赖注入架构清晰、可维护、易于测试。